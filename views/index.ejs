<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>MelodyHub</title>
  </head>
  <link rel="stylesheet" href="/css/index.css" />
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
    integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA=="
    crossorigin="anonymous"
    referrerpolicy="no-referrer"
  />

  <body>
    <header>
      <img src="/image/MelodyHub.png" alt="logo" />
      <div class="search_songs">
        <input
          type="text"
          placeholder="Search for songs..."
          id="searchInput"
          class="search_box hidden"
          name="search"
        />
      </div>
      <div class="usernameDisplay">
        <div style="display: flex; margin-right: 120px">
          <i class="fa-solid fa-user" style="padding: 12px"></i>
          <% if (username) { %>
          <h4 style="font-size: 1.3rem; margin-top: 10px"><%= username %></h4>
          <% } else { %>
          <h4>Welcome Guest</h4>
          <% } %>
        </div>
        <form action="/logout" method="post">
          <button
            type="submit"
            style="
              margin-left: 170px;
              margin-top: 10px;
              border: 2px solid black;
              color: white;
              font-size: 1.1rem;
              background-color: black;
              font-family: 'Gill Sans', 'Gill Sans MT', Calibri, 'Trebuchet MS',
                sans-serif;
            "
          >
            LOGOUT
          </button>
        </form>
      </div>
    </header>

    <div class="content">
      <div class="sidebar">
        <i class="fa-solid fa-magnifying-glass sidebar-icon search_icon"></i>

        <div class="plus-song">
          <i class="fa-solid fa-plus sidebar-icon" id="plus"></i>
        </div>

        <div class="edit">
          <button id="manage">
            <i class="fa-solid fa-bars" style="color: white"></i>
          </button>
        </div>

        <ul class="playListNames">
          <!-- <li class="box">
            <i class="fa-solid fa-music"></i>
            <a class="openPlaylists">Latest Release</a>
          </li> -->
          <% uniqueNames.forEach((uniqueName)=> { %>
          <li class="box">
            <i class="fa-solid fa-music"></i>
            <a class="openPlaylists"> <%= uniqueName%> </a>
          </li>
          <% }); %>
        </ul>
      </div>

      <div class="container">
        <div class="middle-part">
          <ul class="lines" id="firstSearchLine">
            <div class="group-name">
              Top Search Results
              <i class="fa-solid fa-xmark" id="removeSearchResults"></i>
            </div>

            <li class="group"></li>
          </ul>

          <form class="playlist" action="/" method="post">
            <input type="hidden" name="action" value="showPlayList" />
            <div class="head">
              <div class="playListName">PlayList Name</div>
              <i class="fa-solid fa-xmark" id="removePlaylist"></i>
            </div>

            <ul class="heading">
              <li class="headingList">
                <!-- <p>S.NO.</p> -->
                <p id="name">Song Title</p>
                <p id="artist">Artist Name</p>
              </li>
            </ul>

            <ul class="songListOfPlaylist"></ul>
          </form>

          <ul class="lines">
            <div class="group-name">Latest Release</div>

            <li class="group">
              <div class="card">
                <img src="/image/1.jpg" alt="songimage" id="songImage" />
                <div class="caption">
                  <span class="naming">
                    <h5 id="song_name">Aaj Phir Jeene Ki</h5>
                    <h5 id="artist_name">Lata Mangeshkar</h5>
                  </span>
                  <div class="playbtn">
                    <button class="playButton">
                      <i class="fa-solid fa-play"></i>
                    </button>
                    <i class="fa-solid fa-circle-plus addToPlaylist"></i>
                  </div>
                </div>
              </div>
              <div class="card">
                <img src="/image/2.jpg" alt="songimage" />
                <div class="caption">
                  <span class="naming">
                    <h5 id="song_name">Still With You</h5>
                    <h5 id="artist_name">JJK</h5>
                  </span>
                  <div class="playbtn">
                    <button class="playButton">
                      <i class="fa-solid fa-play"></i>
                    </button>
                    <i class="fa-solid fa-circle-plus addToPlaylist"></i>
                  </div>
                </div>
              </div>
              <div class="card">
                <img src="/image/3.jpeg" alt="songimage" />
                <div class="caption">
                  <span class="naming">
                    <h5 id="song_name">Excuses</h5>
                    <h5 id="artist_name">AP Dhillon</h5>
                  </span>
                  <div class="playbtn">
                    <button class="playButton">
                      <i class="fa-solid fa-play"></i>
                    </button>
                    <i class="fa-solid fa-circle-plus addToPlaylist"></i>
                  </div>
                </div>
              </div>
              <div class="card">
                <img src="/image/4.jpeg" alt="songimage" id="songImage" />
                <div class="caption">
                  <span class="naming">
                    <h5 id="song_name">Ve Haaniyaan</h5>
                    <h5 id="artist_name">Avvy Sara</h5>
                  </span>
                  <div class="playbtn">
                    <button class="playButton">
                      <i class="fa-solid fa-play"></i>
                    </button>
                    <i class="fa-solid fa-circle-plus addToPlaylist"></i>
                  </div>
                </div>
              </div>
              <div class="card">
                <img src="/image/5.jpeg" alt="songimage" />
                <div class="caption">
                  <span class="naming">
                    <h5 id="song_name">Munda Sona Hun Main</h5>
                    <h5 id="artist_name">Diljit Dosanjh</h5>
                  </span>
                  <div class="playbtn">
                    <button class="playButton">
                      <i class="fa-solid fa-play"></i>
                    </button>
                    <i class="fa-solid fa-circle-plus addToPlaylist"></i>
                  </div>
                </div>
              </div>
            </li>
          </ul>

          <div class="new-playlist">
            <i class="fa-solid fa-xmark" id="cross"></i>
            <h3>Create New PlayList</h3>
            <form action="/" method="post" id="createNewPlaylist">
              <input type="hidden" name="action" value="createPlaylist" />
              <input
                type="text"
                placeholder="New PlayList"
                id="input"
                name="name"
                required
              />
            </form>
          </div>

          <div class="songLists">
            <h3>
              Latest Release
              <i class="fa-solid fa-xmark" id="remove"></i>
            </h3>
            <ul class="songListItems">
              <% songs.forEach(song=> { %>
              <li class="songItem">
                <h5 class="queueSong"><%=song.name%></h5>
                <button class="playQueue">
                  <i class="fa-solid fa-play"></i>
                </button>
              </li>
              <% }); %>
            </ul>
          </div>

          <form action="/" method="post" class="addToPlaylistForm">
            <i class="fa-solid fa-xmark" id="crossNew"></i>
            <h3 class="selectedSongName">Song Name</h3>
            <hr />
            <h3 class="addToQueue">Add To Queue</h3>
            <div class="break">
              <hr />
              Or Add to Existing Playlist
              <hr />
            </div>
            <select name="playlistName" required class="selectOfPlaylistName">
              <% uniqueNames.forEach((uniqueName)=> { %>
              <option value="<%= uniqueName %>"><%= uniqueName %></option>
              <% }); %>
            </select>
            <button type="submit" class="formbtn">Add to Playlist</button>
          </form>

          <ul class="lines">
            <div class="group-name">Liked</div>
            <li class="group">
              <% songs.forEach(song=> { %>
              <div class="card">
                <img src="<%= song.image %>" alt="songimage" />
                <div class="caption">
                  <span class="naming">
                    <h5 id="song_name"><%= song.name%></h5>
                    <h5 id="artist_name"><%= song.artist%></h5>
                  </span>
                  <div class="playbtn">
                    <button class="playButton">
                      <i class="fa-solid fa-play"></i>
                    </button>
                    <i class="fa-solid fa-circle-plus addToPlaylist"></i>
                  </div>
                </div>
              </div>
              <% }); %>
            </li>
          </ul>

          <form class="delete" action="/" method="post">
            <input type="hidden" name="action" value="deletePlaylist" />
            <div class="deleteHead">
              <h3>Playlists</h3>
              <i class="fa-solid fa-xmark" id="removeList"></i>
            </div>
            <ul class="totalplaylist">
              <li class="list">
                <h4>Latest Release</h4>
              </li>

              <% uniqueNames.forEach((uniqueName)=> { %>
              <li class="list">
                <h4 class="p_name"><%= uniqueName%></h4>
                <button
                  type="submit"
                  name="playlistName"
                  value="<%= uniqueName %>"
                >
                  <i class="fa-solid fa-trash"></i>
                </button>
              </li>
              <% }); %>
            </ul>
          </form>
        </div>

        <div class="player">
          <div class="queue">
            <div class="playlist-name">Latest Release</div>
            <i class="fa-solid fa-list-ul" id="queueBtn"></i>
          </div>

          <div class="details">
            <!-- <div class="now-playing">PLAYING x OF y</div> -->
            <div class="now-playing">PLAYING</div>
            <div class="track-art">
              <img src="" alt="currentPlayingSongImage" />
            </div>
            <div class="track-name" id="trackName">Track Name</div>
            <div class="track-artist">Track Artist</div>
          </div>

          <div class="buttons">
            <button class="prev-track btn" id="previous">
              <i class="fa fa-step-backward fa-2x"></i>
            </button>

            <button class="playpause-track btn" id="playpause">
              <i class="fa fa-play-circle fa-5x"></i>
            </button>

            <button class="next-track btn" id="next">
              <i class="fa fa-step-forward fa-2x"></i>
            </button>
          </div>

          <div class="slider_container">
            <div class="current-time">00:00</div>
            <input
              type="range"
              min="1"
              max="100"
              value="0"
              class="seek_slider"
              id="audioSlider"
            />
            <div class="total-duration">00:00</div>
          </div>

          <div class="slider_container">
            <i class="fa fa-volume-down"></i>
            <input
              type="range"
              min="1"
              max="100"
              value="99"
              class="volume_slider"
              id="volumeSlider"
            />
            <i class="fa fa-volume-up"></i>
          </div>
        </div>
      </div>
    </div>
  </body>
  <script src="/js/indexx.js"></script>
  <script>
    document.addEventListener("DOMContentLoaded", function () {
      var prevbutton = document.getElementById("previous");
      prevbutton.addEventListener("click", function () {
        prevTrack();
      });

      var playbutton = document.getElementById("playpause");
      playbutton.addEventListener("click", function () {
        playpauseTrack();
      });

      var nextbutton = document.getElementById("next");
      nextbutton.addEventListener("click", function () {
        nextTrack();
      });

      const audioSlider = document.getElementById("audioSlider");
      audioSlider.addEventListener("change", function () {
        seekTo();
      });

      const volumeSlider = document.getElementById("volumeSlider");
      volumeSlider.addEventListener("change", function () {
        setVolume();
      });

      const cross = document.querySelector("#cross");
      cross.addEventListener("click", function () {
        removeBlock();
      });

      const plus = document.querySelector("#plus");
      plus.addEventListener("click", function () {
        openBlock();
      });

      let inputBox = document.querySelector("#input");
      inputBox.addEventListener("keyup", (event) => {
        if (event.key == "Enter") {
          if (inputBox.value == "") {
            alert("Please Enter a Value");
          } else {
            addItem(inputBox.value);
            inputBox.value = "";
          }
        }
      });

      const queueBtn = document.querySelector("#queueBtn");
      queueBtn.addEventListener("click", function () {
        showQueueList();
      });

      const removeQueue = document.querySelector("#remove");
      removeQueue.addEventListener("click", function () {
        removeQueueList();
      });

      const search_icon = document.querySelector(".search_icon");
      search_icon.addEventListener("click", function () {
        toggleSearchBar();
      });

      const removeSearchResults = document.querySelector(
        "#removeSearchResults"
      );
      removeSearchResults.addEventListener("click", function () {
        const firstSearchLine = document.querySelector("#firstSearchLine");
        firstSearchLine.style.display = "none";
      });

      const playButtons = document.querySelectorAll(".playButton");
      playButtons.forEach(function (button) {
        button.addEventListener("click", function (event) {
          const card = button.closest(".card");
          const trackName = card.querySelector("#song_name").innerText;
          updatePlayerAndPlay(trackName);
        });
      });

      const playQueue = document.querySelectorAll(".playQueue");
      playQueue.forEach(function (e) {
        e.addEventListener("click", function (event) {
          console.log("playQueue is clicked");
          const list = e.closest(".songItem");
          const queueSongName = list.querySelector(".queueSong").innerText;
          // console.log(queueSongName);
          updatePlayerAndPlay(queueSongName);
        });
      });

      const manageList = document.querySelector("#manage");
      manageList.addEventListener("click", function () {
        openManageList();
      });

      const removeList = document.querySelector("#removeList");
      removeList.addEventListener("click", function () {
        closeManageList();
      });

      const searchInput = document.getElementById("searchInput");
      const cardContainer = document.querySelector(".card");
      searchInput.addEventListener("keyup", async (event) => {
        if (event.key == "Enter") {
          if (searchInput.value == "") {
            alert("Please enter something to search for!");
          } else {
            const songSearched = searchSongs(searchInput.value);
            displaySearchResults(songSearched);
            searchInput.value = "";
          }
        }
      });

      const openPlaylists = document.querySelectorAll(".openPlaylists");
      openPlaylists.forEach(function (btn) {
        btn.addEventListener("click", async function () {
          const boxli = btn.closest(".box");
          const play_list_name =
            boxli.querySelector(".openPlaylists").innerText;
          // console.log(play_list_name);
          const playlist = document.querySelector(".playlist");
          try {
            const response = await fetch("/", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({
                action: "showPlayList",
                play_list_name: play_list_name,
              }),
            });
            const data = await response.json();
            // console.log('Data.songs : ', data.songs);
            showPlayLists(play_list_name);
            // console.log('Update playlist called');
            updatePlaylist(data.songs);

            if (!response.ok) {
              throw new Error("Failed to fetch playlist");
            }

            // parentPlaylist.remove();
          } catch (error) {
            console.error("Error fetching  playlist:", error);
          }
        });
      });

      const removePlaylist = document.querySelector("#removePlaylist");
      removePlaylist.addEventListener("click", function () {
        hidePlayLists();
      });

      const playPlayList = document.querySelectorAll(".playPlayList");
      playPlayList.forEach(function (btn) {
        btn.addEventListener("click", function (event) {
          const list = btn.closest(".listOfSongs");
          const trackName = list.querySelector("#name_of_song").innerText;
          updatePlayerAndPlay(trackName);
        });
      });

      const crossNew = document.querySelector("#crossNew");
      crossNew.addEventListener("click", () => {
        closeFormForAddingANewSong();
      });

      const addToPlaylist = document.querySelectorAll(".addToPlaylist");
      addToPlaylist.forEach(function (btn) {
        btn.addEventListener("click", function () {
          const songCard = btn.closest(".card");
          const currSongName = songCard.querySelector("#song_name").innerText;
          console.log(currSongName);
          openFormToAddToPlayList(currSongName);
        });
      });

      const addToQueue = document.querySelector(".addToQueue");
      addToQueue.addEventListener("click", () => {
        const nameOfSong =
          document.querySelector(".selectedSongName").textContent;
        saveSongToQueue(nameOfSong);
      });
    });
    document.addEventListener("DOMContentLoaded", function () {
      const addToPlaylistForms =
        document.querySelectorAll(".addToPlaylistForm");

      addToPlaylistForms.forEach(function (form) {
        form.addEventListener("submit", async function (event) {
          event.preventDefault(); // Prevent the default form submission

          const songName = form
            .querySelector(".selectedSongName")
            .innerText.trim();
          const playlistName = form
            .querySelector('select[name="playlistName"]')
            .value.trim();
          // console.log(songName, playlistName);

          try {
            const response = await fetch("/", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({
                action: "addToPlaylist",
                songName: songName,
                playlistName: playlistName,
              }),
            });
            console.log(response);

            if (!response.ok) {
              throw new Error("Failed to add song to playlist");
            }

            form.reset();
          } catch (error) {
            console.error("Error adding song to playlist:", error);
          }
        });
      });
    });

    document.addEventListener("DOMContentLoaded", function () {
      const deleteIcons = document.querySelectorAll(".fa-trash");

      deleteIcons.forEach((icon) => {
        icon.addEventListener("click", async () => {
          const parentPlaylist = icon.closest(".list");
          const playlistName = parentPlaylist
            .querySelector(".p_name")
            .textContent.trim();

          try {
            const response = await fetch("/", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({
                action: "deletePlaylist",
                playlistName: playlistName,
              }),
            });

            if (!response.ok) {
              throw new Error("Failed to delete playlist");
            }

            parentPlaylist.remove();
          } catch (error) {
            console.error("Error deleting playlist:", error);
          }
        });
      });
    });
  </script>
</html>
